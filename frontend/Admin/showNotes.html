<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <div id="notes"></div>
  </body>
</html>

<script>
  let bag = [];//global
  let bag2={};//global
  async function show() {//FETCH---->
    let res = await fetch("https://mysterious-red-uniform.cyclic.app/notes", {
      headers: { Authorization: localStorage.getItem("token") },
    })
      .then((res) => res.json())
      .then((res) => {
        console.log(res);
        bag = [...res];
        display(bag);//DISPLAY------>
      })
      .catch((err) => {
        console.log(err);
      });
  }
  show();

  function display(bag) {
    document.getElementById("notes").innerHTML = "";
    document.getElementById("notes").innerHTML = `
    ${bag
      .map((item) => {
        let id = item._id;
        let title = item.title;
        let note = item.note;
        let category = item.category;
        return renderCard(title, note, category, id);//CARD------>
      })
      .join("")}
    `;

    let delete_btns = document.querySelectorAll(".delete-btn");
    for (delete_btn of delete_btns) {
      delete_btn.addEventListener("click", function () {
        let id = event.target.dataset.id;
        // console.log(id);
        deleteNote(id);
      });
    }

    let update_btns = document.querySelectorAll(".update-btn");
    for (update_btn of update_btns) {
      update_btn.addEventListener("click", function () {
        let id = event.target.dataset.id;
        // console.log(id);
        updateNote(id);
      });
    }
  }

  function renderCard(title, note, category, id) {
    return `<div>
        <h4>${title}</h4>
        <h5>${note}</h5>
        <h5>${category}</h5>
        <button  class="delete-btn" data-id=${id} >Delete</button>
        <button class="update-btn" data-id="${id}">Update</button>
      </div>`;
  }
  
  async function deleteNote(id) {
    let res1 = await fetch(`https://mysterious-red-uniform.cyclic.app/notes/delete/${id}`, {
      method: "DELETE",
      headers: { Authorization: localStorage.getItem("token") },
    })
      .then((res) => res.json())
      .then((res) => {
        alert("DELETED");
        console.log(res);
      })
      .catch((err) => {
        console.log(err);
      });
    let res2 = await fetch("https://mysterious-red-uniform.cyclic.app/notes", {
      headers: { Authorization: localStorage.getItem("token") },
    });
    let data = await res2.json();
    console.log(data);
    display(data);
  }

  async function updateNote(id) {
    document.getElementById("notes").innerHTML = "";
    document.getElementById("notes").innerHTML = `<div id="update">
      <input type="text" id="title" placeholder="Enter title" />
      <input type="text" id="note" placeholder="Enter Notes" />
      <input type="text" id="category" placeholder="Enter Category" />
      <input type="submit" id="btn" />
    </div>`;
    let btn = document.getElementById("btn");
    btn.addEventListener("click", async function () {
      let title = document.getElementById("title").value;
      let note = document.getElementById("note").value;
      let category = document.getElementById("category").value;
      let noteData = {
        title,
        note,
        category,
      };
      console.log(noteData)
      bag2={...noteData}
      noteUpdate(id,bag2)
    })
  }

  async function noteUpdate(id,bag2){
    let res = await fetch(`https://mysterious-red-uniform.cyclic.app/notes/update/${id}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          Authorization: localStorage.getItem("token"),
        },
        body: JSON.stringify(bag2),
      });
      if(res.ok){
      alert("Note Update");
      show();
      }
  }
</script>
